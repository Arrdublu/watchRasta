rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * The user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * The requesting user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ----------------------------------------------------------------------
    // User Data Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to a user's root document.
     * @path /users/{userId}
     * @allow (create, get, update) A user can create, read, and update their own document.
     * @deny (list, delete) A user cannot list all other users or delete their own account from the client.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;

      /**
       * @description Controls access to a user's private profile documents.
       * @path /users/{userId}/profile/{profileId}
       * @allow (CRUD, list) The owner can perform all operations on their own profile documents.
       * @deny (any) Another authenticated user cannot access this user's profile data.
       * @principle Enforces strict data ownership within a user-specific subcollection.
       */
      match /users/{userId}/profile/{profileId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }

    // ----------------------------------------------------------------------
    // Global Role Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages documents that grant admin privileges.
     * @path /roles_admin/{userId}
     * @allow (none) No client is allowed to read or write to this collection directly.
     * @deny (all) All client-side requests are rejected.
     * @principle Secures role-granting documents by making them server-managed only. Authorization is performed via `exists()` checks, not direct reads.
     */
    match /roles_admin/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}